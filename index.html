<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JVS Vodárenský Management</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
html, body {margin:0;height:100%;background:#0f172a;color:#f8fafc;}
#map {height:100dvh;width:100vw;}
.quick {position:absolute;bottom:20px;right:20px;background:#1e293b;padding:8px 12px;border-radius:8px;}
</style>
</head>

<body>
<div id="map"></div>
<div class="quick" id="quickStats"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// === Firebase init ===
const firebaseConfig = {
  apiKey: "AIzaSyExample",
  authDomain: "jvs-app.firebaseapp.com",
  projectId: "jvs-app"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// === Load data ===
let arealy = [];
async function loadData() {
  try {
    const res = await fetch('arealy.json');
    arealy = await res.json();
    createMap();
  } catch(e){ console.error(e); }
}

// === Map setup ===
function createMap(){
  const map = L.map('map').setView([49.1,14.4],9);
  const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});
  base.addTo(map);

  const cluster = L.markerClusterGroup();
  const heat = [];
  arealy.forEach(a=>{
    const marker = L.marker([a.lat,a.lon]);
    marker.bindPopup(`<b>${a.nazev}</b><br>${a.okres}<br>${a.vymera} m²`);
    cluster.addLayer(marker);
    heat.push([a.lat,a.lon,0.6]);
  });
  L.heatLayer(heat,{radius:25}).addTo(map);
  map.addLayer(cluster);

  // === Routing ===
  const routing = L.Routing.control({
    router: L.Routing.osrmv1({ serviceUrl:'https://router.project-osrm.org/route/v1' }),
    waypoints: [],
    addWaypoints: true
  }).addTo(map);

  // === Geolocation & sort ===
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(pos=>{
      const user = [pos.coords.latitude,pos.coords.longitude];
      const sorted = arealy.map(a=>({...a,dist:distance(user,[a.lat,a.lon])}))
                           .sort((x,y)=>x.dist-y.dist);
      document.getElementById('quickStats').innerText =
        `Nejblíže: ${sorted[0].nazev} (${sorted[0].dist.toFixed(1)} km)`;
    });
  }
}

function distance(a,b){
  const R=6371;const dLat=(b[0]-a[0])*Math.PI/180;const dLon=(b[1]-a[1])*Math.PI/180;
  const aa=Math.sin(dLat/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
}

// === Push notifications & geofence ===
if ('Notification' in window && Notification.permission!=='granted') Notification.requestPermission();
function notify(msg){ if(Notification.permission==='granted') new Notification(msg); }
navigator.geolocation.watchPosition(p=>{
  arealy.forEach(a=>{
    const d=distance([p.coords.latitude,p.coords.longitude],[a.lat,a.lon]);
    if(d<0.5 && a.kat==="I.") notify(`Blížíte se k areálu ${a.nazev}`);
  });
});

// === SW registration ===
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

loadData();
</script>
</body>
</html>