<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>JVS Provozn√≠ mapa</title>

    <!-- Leaflet & Extensions -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Nastaven√≠ Tailwind configu pro tmav√Ω, elegantn√≠ design a responsivitu
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // Modr√° (Blue 500)
                        secondary: '#1f2937', // Tmavƒõ ≈°ed√° (Gray 800)
                        success: '#10b981', // Zelen√° (Emerald 500)
                        danger: '#ef4444', // ƒåerven√° (Red 500)
                        warning: '#f59e0b', // Oran≈æov√° (Amber 500)
                        background: '#0f172a' // Tmavƒõ modr√° (Slate 900)
                    }
                }
            }
        }
    </script>

    <style>
        /* Z√°kladn√≠ styly pro mobiln√≠ optimalizaci a iOS 100dvh fix */
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #0f172a; color: #e5e7eb; font-family: 'Inter', system-ui; }
        #mapWrapper { height: 100dvh; width: 100%; position: relative; }
        
        /* Fallback pro star≈°√≠ iOS */
        @supports (-webkit-touch-callout: none) {
            body, #mapWrapper { height: -webkit-fill-available; }
        }
        
        /* Bottom Sheet Panel */
        .panel { 
            transition: transform .3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh; /* Omezuje panel, aby se nezakryl cel√Ω displej */
        }
        
        /* Map fixy */
        #map { height: 100%; width: 100%; }
        .leaflet-popup-content-wrapper { background: #1f2937; color: #e5e7eb; border-radius: 0.75rem; }
        .leaflet-popup-tip { background: #1f2937; }
        .leaflet-draw-section a { color: #3b82f6 !important; }

        /* Toast Notifikace */
        .toast {
            animation: fadeInOut 4s ease-in-out forwards;
            pointer-events: none;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Loading Spinner */
        .spinner { border: 4px solid rgba(255,255,255,.1); border-left-color: #3b82f6; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0) } 100% { transform: rotate(360deg) } }
    </style>
</head>

<body class="bg-background text-white">

<!-- Header -->
<header class="fixed top-0 left-0 right-0 z-[1000] bg-background/90 backdrop-blur flex items-center justify-between p-4 shadow-xl">
    <div class="flex items-center gap-2">
        <i class="fas fa-water text-primary text-2xl"></i>
        <h1 class="text-xl font-bold">JVS Provoz</h1>
        <span id="userIdDisplay" class="text-xs opacity-50 ml-2">ID: ...</span>
    </div>
    <div class="flex gap-2">
        <button id="locateBtn" class="bg-primary/20 text-primary p-3 rounded-full text-lg shadow-lg hover:bg-primary/30 transition-colors"><i class="fas fa-location-crosshairs"></i></button>
        <button onclick="togglePanel()" class="bg-primary/20 text-primary p-3 rounded-full text-lg shadow-lg hover:bg-primary/30 transition-colors"><i class="fas fa-sliders-h"></i></button>
    </div>
</header>

<!-- Map Container -->
<div id="mapWrapper">
    <div id="map"></div>
</div>

<!-- Toast Notifications Container -->
<div id="toastContainer" class="fixed top-20 right-4 z-[1001] space-y-2"></div>

<!-- Modal Container (for Add/Edit) -->
<div id="modal" class="fixed inset-0 bg-black/70 z-[1002] flex items-center justify-center p-4 hidden">
    <div id="modalContent" class="bg-slate-800 rounded-xl p-6 w-full max-w-md shadow-2xl space-y-4">
        <h2 id="modalTitle" class="text-xl font-bold text-primary"></h2>
        <form id="areaForm" class="space-y-3">
            <input type="hidden" id="areaIndex">
            <input type="hidden" id="areaLat">
            <input type="hidden" id="areaLng">
            
            <label class="block">N√°zev:<input type="text" id="areaName" required class="w-full p-3 rounded bg-slate-700 border border-slate-600 focus:ring-primary focus:border-primary"></label>
            <label class="block">Okres:<input type="text" id="areaDistrict" required class="w-full p-3 rounded bg-slate-700 border border-slate-600"></label>
            <label class="block">Kategorie (I./II./pr√°zdn√©):<input type="text" id="areaCategory" class="w-full p-3 rounded bg-slate-700 border border-slate-600"></label>
            <label class="block">Plocha (m¬≤):<input type="number" id="areaArea" required class="w-full p-3 rounded bg-slate-700 border border-slate-600"></label>
            <label class="block">Oplocen√≠ (bm):<input type="number" id="areaFence" required class="w-full p-3 rounded bg-slate-700 border border-slate-600"></label>

            <button type="submit" class="w-full bg-success py-3 rounded-lg text-lg font-semibold hover:bg-success/90 transition-colors">Ulo≈æit zmƒõny</button>
            <button type="button" onclick="hideModal()" class="w-full bg-slate-600 py-3 rounded-lg text-lg font-semibold mt-2 hover:bg-slate-500 transition-colors">Zru≈°it</button>
        </form>
    </div>
</div>

<!-- Bottom Sheet Panel -->
<div class="fixed bottom-0 left-0 right-0 z-[1000] bg-secondary/95 backdrop-blur rounded-t-3xl shadow-2xl panel" id="panel" style="transform:translateY(calc(100% - 70px))">
    <!-- Handle pro vysunut√≠ -->
    <div class="h-[70px] flex items-center justify-center cursor-pointer" onclick="togglePanel()">
        <i class="fas fa-chevron-up text-3xl text-primary/70 transition-transform duration-300" id="panelHandleIcon"></i>
    </div>
    
    <div class="p-4 space-y-6 overflow-y-auto" id="panelContent">
        
        <div class="section bg-slate-800 p-4 rounded-xl shadow-inner">
            <h2 class="text-lg font-bold mb-3 text-primary">üìä Souhrn & Filtry</h2>
            
            <!-- Souhrnn√© statistiky -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold" id="totalArea">0</div>
                    <div class="text-xs opacity-70">Celkov√° plocha (m¬≤)</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold text-danger" id="remainingArea">0</div>
                    <div class="text-xs opacity-70">Zb√Ωv√° sekat (m¬≤)</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold" id="totalFence">0</div>
                    <div class="text-xs opacity-70">Oplocen√≠ (bm)</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold" id="objectCount">0</div>
                    <div class="text-xs opacity-70">Are√°l≈Ø (filtr)</div>
                </div>
            </div>

            <!-- Filtry -->
            <input id="searchInput" type="text" placeholder="Hledat n√°zev are√°lu..." class="w-full p-3 rounded bg-slate-700 border border-slate-600 mt-2">
            <select id="districtFilter" class="w-full p-3 rounded bg-slate-700 border border-slate-600 mt-2">
                <option value="">V≈°echny okresy</option>
            </select>
            <div class="mt-2 flex gap-2">
                <label for="heatmapToggle" class="flex-grow flex items-center justify-between bg-slate-700 p-3 rounded-lg cursor-pointer">
                    <span>Heatmapa rizika</span>
                    <input type="checkbox" id="heatmapToggle" class="w-5 h-5 text-primary bg-slate-600 border-slate-500 rounded focus:ring-primary" onchange="toggleHeatmap()">
                </label>
                <label for="maintainedToggle" class="flex-grow flex items-center justify-between bg-slate-700 p-3 rounded-lg cursor-pointer">
                    <span>Jen k √∫dr≈æbƒõ</span>
                    <input type="checkbox" id="maintainedToggle" class="w-5 h-5 text-primary bg-slate-600 border-slate-500 rounded focus:ring-primary">
                </label>
            </div>
            
        </div>

        <div class="section bg-slate-800 p-4 rounded-xl shadow-inner">
            <h2 class="text-lg font-bold mb-3 text-primary">üó∫Ô∏è Trasa a Navigace</h2>
            <div id="routeStatus" class="text-sm opacity-80 mb-3">Trasa nen√≠ aktivn√≠. P≈ôidejte alespo≈à 2 are√°ly.</div>
            <div id="routeList" class="space-y-2 mb-4">
                <!-- Zde se dynamicky napln√≠ body trasy -->
            </div>
            <button onclick="resetRoute()" class="w-full bg-warning py-3 rounded-lg mb-2"><i class="fas fa-route"></i> Reset trasy</button>
            <button onclick="generateAIReport()" class="w-full bg-purple-600 py-3 rounded-lg"><i class="fas fa-robot"></i> Generovat AI Protokol</button>
        </div>

        <div class="section bg-slate-800 p-4 rounded-xl shadow-inner">
            <h2 class="text-lg font-bold mb-3 text-primary">‚òÅÔ∏è Poƒças√≠ v centru mapy</h2>
            <div id="weatherContent" class="text-center py-4 text-sm"><div class="spinner"></div></div>
        </div>

        <div class="section">
             <button onclick="addNewAreaInit()" class="w-full bg-success py-3 rounded-lg text-lg font-semibold"><i class="fas fa-plus"></i> P≈ôidat nov√Ω are√°l</button>
        </div>
        
        <div class="section text-center p-4">
             <button onclick="resetAllData()" class="text-sm text-danger/70 hover:text-danger">Glob√°ln√≠ Reset Dat (vyma≈æe lok√°ln√≠ data i trasu)</button>
        </div>
        
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Glob√°ln√≠ promƒõnn√© z Canvas prost≈ôed√≠
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // P≈ôid√°me promƒõnn√© do window pro p≈ô√≠stup z venkovn√≠ho skriptu
    window.db = null;
    window.auth = null;
    window.userId = null;
    window.serverTimestamp = serverTimestamp;
    window.doc = doc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.setDoc = setDoc;
    window.addDoc = addDoc;
    window.collection = collection;
    window.onSnapshot = onSnapshot;

    setLogLevel('error'); // Omez√≠me logov√°n√≠

    if (Object.keys(firebaseConfig).length > 0) {
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);

        // Anonymn√≠ nebo custom p≈ôihl√°≈°en√≠
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.userId = user.uid;
                document.getElementById('userIdDisplay').textContent = `ID: ${user.uid.substring(0, 8)}...`;
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        window.userId = window.auth.currentUser.uid;
                        document.getElementById('userIdDisplay').textContent = `ID: ${window.userId.substring(0, 8)}...`;
                    } else {
                        await signInAnonymously(window.auth);
                        window.userId = window.auth.currentUser.uid;
                        document.getElementById('userIdDisplay').textContent = `ID: ${window.userId.substring(0, 8)} (anonym)`;
                    }
                } catch (error) {
                    console.error("Chyba p≈ôihl√°≈°en√≠ Firebase:", error);
                    window.userId = crypto.randomUUID(); // Fallback pro neautentizovan√©ho u≈æivatele
                    document.getElementById('userIdDisplay').textContent = `ID: GUEST`;
                }
            }
            // Po dokonƒçen√≠ autentizace inicializujeme aplikaci
            window.isAuthReady = true;
            window.initApp(); 
        });
    } else {
        console.warn("Firebase config nen√≠ k dispozici. Pou≈æ√≠v√°m pouze LocalStorage.");
        window.userId = crypto.randomUUID();
        document.getElementById('userIdDisplay').textContent = `ID: OFFLINE`;
        window.isAuthReady = true;
        window.initApp();
    }
</script>


<script>
// === DATA ARE√ÅL≈Æ (41 polo≈æek) ===
// Roz≈°√≠≈ôeno o last_maintenance (pro simulaci rizika)
const initialAreas = [
  {id: 'vdj_amerika_ii', name:"VDJ Amerika II",district:"PI",lat:49.305131,lng:14.166126,area:3303,fence:293,cat:"I.", last_maintenance: '2025-05-15', is_maintained: false},
  {id: 'vdj_drahonice', name:"VDJ Drahonice",district:"ST",lat:49.202902,lng:14.063713,area:5953,fence:376,cat:"I.", last_maintenance: '2025-06-20', is_maintained: false},
  {id: 'vdj_vodnany', name:"VDJ Vod≈àany",district:"ST",lat:49.164550,lng:14.177836,area:1594,fence:252,cat:"I.", last_maintenance: '2025-06-25', is_maintained: false},
  {id: 'vdj_hlavatce', name:"VDJ Hlavatce",district:"CB",lat:49.063584,lng:14.267751,area:7968,fence:424,cat:"B", last_maintenance: '2025-04-10', is_maintained: false}, // Bez kategorie (B)
  {id: 'vdj_sibenicni_vrch_i', name:"VDJ ≈†ibeniƒçn√≠ vrch I",district:"PT",lat:49.025083,lng:13.994111,area:1835,fence:245,cat:"I.", last_maintenance: '2025-07-01', is_maintained: false},
  {id: 'uv_husinecka', name:"√öV Husinecka p≈ôehrada",district:"PT",lat:49.034362,lng:13.996830,area:4908,fence:703,cat:"B", last_maintenance: '2025-05-01', is_maintained: false}, // Bez kategorie (B)
  {id: 'vdj_sibenicni_vrch_ii', name:"VDJ ≈†ibeniƒçn√≠ vrch II",district:"PT",lat:49.026710,lng:13.994001,area:3206,fence:340,cat:"I.", last_maintenance: '2025-06-05', is_maintained: false},
  {id: 'vdj_zaluzany', name:"VDJ Z√°lu≈æany",district:"PI",lat:49.552857,lng:14.083381,area:2350,fence:299,cat:"B", last_maintenance: '2025-04-20', is_maintained: false}, // Bez kategorie (B)
  {id: 'vdj_ptacnik', name:"VDJ Pt√°ƒçn√≠k",district:"PT",lat:49.066147,lng:14.186844,area:1070,fence:239,cat:"II.", last_maintenance: '2025-07-10', is_maintained: false},
  {id: 'vdj_zdoba', name:"VDJ Zdoba",district:"CB",lat:49.212422,lng:14.338095,area:15523,fence:225,cat:"II.", last_maintenance: '2025-05-25', is_maintained: false},
  {id: 'vdj_domoradice', name:"VDJ Domoradice",district:"CK",lat:48.829651,lng:14.326564,area:4148,fence:450,cat:"I.", last_maintenance: '2025-06-01', is_maintained: false},
  {id: 'vdj_horni_brana', name:"VDJ Horn√≠ Br√°na",district:"CK",lat:48.807970,lng:14.329352,area:1665,fence:187,cat:"I.", last_maintenance: '2025-07-15', is_maintained: false},
  {id: 'vdj_netrebice', name:"VDJ Net≈ôebice",district:"CK",lat:48.783277,lng:14.456447,area:877,fence:136,cat:"I.", last_maintenance: '2025-06-18', is_maintained: false},
  {id: 'vdj_plesivec', name:"VDJ Ple≈°ivec",district:"CK",lat:48.802231,lng:14.304933,area:975,fence:119,cat:"I.", last_maintenance: '2025-07-05', is_maintained: false},
  {id: 'vdj_doudleby', name:"VDJ Doudleby",district:"CB",lat:48.888896,lng:14.480271,area:413,fence:79,cat:"II.", last_maintenance: '2025-05-10', is_maintained: false},
  {id: 'vdj_jankov', name:"VDJ Jankov",district:"CB",lat:48.968747,lng:14.301697,area:784,fence:106,cat:"I.", last_maintenance: '2025-07-08', is_maintained: false},
  {id: 'vdj_hosin_ii', name:"VDJ Hos√≠n II",district:"CB",lat:49.030641,lng:14.501012,area:4173,fence:399,cat:"I.", last_maintenance: '2025-06-12', is_maintained: false},
  {id: 'vdj_chlum', name:"VDJ Chlum",district:"CB",lat:49.096493,lng:14.388679,area:535,fence:63,cat:"II.", last_maintenance: '2025-07-03', is_maintained: false},
  {id: 'vdj_chotycany', name:"VDJ Chot√Ωƒçany",district:"CB",lat:49.070748,lng:14.519460,area:4775,fence:338,cat:"II.", last_maintenance: '2025-05-22', is_maintained: false},
  {id: 'vdj_rudolfov_iii', name:"VDJ Rudolfov III",district:"CB",lat:48.986207,lng:14.547076,area:1868,fence:174,cat:"I.", last_maintenance: '2025-07-18', is_maintained: false},
  {id: 'vdj_rimov_vesce', name:"VDJ Rimov - Vesce",district:"CB",lat:48.847847,lng:14.466957,area:662,fence:99,cat:"I.", last_maintenance: '2025-06-08', is_maintained: false},
  {id: 'vdj_hosin', name:"VDJ Hosin",district:"CB",lat:49.033641,lng:14.492878,area:809,fence:125,cat:"II.", last_maintenance: '2025-05-05', is_maintained: false},
  {id: 'vdj_vcelna', name:"VDJ Vƒçeln√°",district:"CB",lat:48.924663,lng:14.463506,area:8660,fence:476,cat:"II.", last_maintenance: '2025-07-20', is_maintained: false},
  {id: 'vdj_hury', name:"VDJ H√∫ry",district:"CB",lat:49.006417,lng:14.549815,area:395,fence:0,cat:"I.", last_maintenance: '2025-06-15', is_maintained: false},
  {id: 'vdj_chlumec', name:"VDJ Chlumec",district:"CB",lat:49.124766,lng:14.431321,area:811,fence:110,cat:"II.", last_maintenance: '2025-07-12', is_maintained: false},
  {id: 'vdj_olesnik', name:"VDJ Ole≈°n√≠k",district:"CB",lat:49.111103,lng:14.377766,area:380,fence:117,cat:"I.", last_maintenance: '2025-05-28', is_maintained: false},
  {id: 'cs_bukovec', name:"ƒåS Bukovec",district:"CB",lat:48.881608,lng:14.449233,area:4943,fence:300,cat:"I.", last_maintenance: '2025-06-03', is_maintained: false},
  {id: 'vdj_herman', name:"VDJ He≈ôman",district:"CB",lat:48.909479,lng:14.499876,area:982,fence:119,cat:"II.", last_maintenance: '2025-07-22', is_maintained: false},
  {id: 'cs_vidov', name:"ƒåS Vidov u ≈ôeky",district:"CB",lat:48.924157,lng:14.489619,area:2501,fence:212,cat:"II.", last_maintenance: '2025-05-18', is_maintained: false},
  {id: 'vrt_vidov', name:"Vrt Vidov",district:"CB",lat:48.924066,lng:14.489679,area:470,fence:164,cat:"II.", last_maintenance: '2025-07-25', is_maintained: false},
  {id: 'uv_plav', name:"√öV Plav",district:"CB",lat:48.912611,lng:14.494018,area:74777,fence:1413,cat:"I.", last_maintenance: '2025-06-28', is_maintained: false},
  {id: 'vdj_cekanice', name:"VDJ ƒåekanice",district:"TA",lat:49.422197,lng:14.689896,area:6344,fence:450,cat:"I.", last_maintenance: '2025-05-09', is_maintained: false},
  {id: 'vdj_svata_anna', name:"VDJ Svat√° Anna",district:"TA",lat:49.401133,lng:14.698640,area:4192,fence:264,cat:"I.", last_maintenance: '2025-07-06', is_maintained: false},
  {id: 'vdj_bezdecin', name:"VDJ Bezdƒõƒç√≠n",district:"TA",lat:49.323096,lng:14.628405,area:1996,fence:169,cat:"I.", last_maintenance: '2025-06-22', is_maintained: false},
  {id: 'vdj_milevsko', name:"VDJ Milevsko",district:"TA",lat:49.452521,lng:14.344102,area:823,fence:129,cat:"I.", last_maintenance: '2025-05-02', is_maintained: false},
  {id: 'vdj_hodusin', name:"VDJ Hodu≈°√≠n",district:"TA",lat:49.429670,lng:14.474214,area:1708,fence:205,cat:"II.", last_maintenance: '2025-07-09', is_maintained: false},
  {id: 'vdj_vsechov', name:"VDJ V≈°echov",district:"TA",lat:49.430159,lng:14.623205,area:1574,fence:199,cat:"I.", last_maintenance: '2025-06-16', is_maintained: false},
  {id: 'vdj_zlukov', name:"VDJ Zlukov",district:"TA",lat:49.196289,lng:14.736382,area:1520,fence:184,cat:"II.", last_maintenance: '2025-05-12', is_maintained: false},
  {id: 'uv_tabor', name:"√öV T√°bor",district:"TA",lat:49.422872,lng:14.666426,area:12262,fence:350,cat:"II.", last_maintenance: '2025-07-14', is_maintained: false},
  {id: 'cs_sudomerice', name:"ƒåS Sudomƒõ≈ôice",district:"TA",lat:49.286580,lng:14.547794,area:2508,fence:220,cat:"I.", last_maintenance: '2025-06-29', is_maintained: false},
  {id: 'vdj_provozni_tabor', name:"Provozn√≠ Vodojem T√°bor",district:"TA",lat:49.424264,lng:14.666384,area:1853,fence:155,cat:"II.", last_maintenance: '2025-05-20', is_maintained: false}
];

let arealData = [];
let filteredAreas = [];
let routePoints = JSON.parse(localStorage.getItem('jvs_route_points')) || [];
let routingControl = null;
let clusterGroup = L.markerClusterGroup({ disableClusteringAtZoom: 14 });
let heatLayer = L.heatLayer([], {radius: 40, blur: 25, maxZoom: 13, gradient: {0.0: '#10b981', 0.5: '#f59e0b', 1.0: '#ef4444'}}); // Zelen√° -> ≈Ωlut√° -> ƒåerven√°
let drawingLayer = new L.FeatureGroup();
let drawControl;
let isDrawing = false;
let map;

// === POMOCN√â FUNKCE ===

function showToast(message, type = 'primary') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast p-3 rounded-lg shadow-lg text-white font-semibold mb-2 bg-${type}-600`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// V√Ωpoƒçet rizikov√©ho sk√≥re (0 - 1)
function calculateRiskScore(area) {
    if (area.is_maintained) return 0; // Nulov√© riziko pro hotov√©
    
    // 1. Dny od posledn√≠ √∫dr≈æby
    const lastMaintenance = new Date(area.last_maintenance);
    const today = new Date();
    const diffTime = Math.abs(today - lastMaintenance);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    // Max rizikov√Ω den (nap≈ô. 180 dn√≠)
    const maxRiskDays = 180;
    let timeScore = Math.min(1, diffDays / maxRiskDays);

    // 2. Kategorie (I. = 1.0, II. = 0.5, Bez/B = 0.2)
    let catWeight = 0;
    if (area.cat === 'I.') catWeight = 1.0;
    else if (area.cat === 'II.') catWeight = 0.5;
    else catWeight = 0.2; // Bez kategorie (B)

    // Kombinace: ƒças m√° vƒõt≈°√≠ v√°hu
    // Max sk√≥re je 1.0. Tady to udƒõl√°me jednodu≈°e: 60% ƒças, 40% kategorie
    return (timeScore * 0.6) + (catWeight * 0.4 * (1 - timeScore)); // Omezen√≠ vlivu kategorie, pokud je √∫dr≈æba ƒçerstv√°
}

// === FIREBASE A DATA ===

function getFirestorePath(collectionName) {
    // Pou≈æ√≠v√°me public data pro sd√≠len√≠ are√°l≈Ø, ale s prefixem userId pro editaci
    const userId = window.userId || 'guest';
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    return `artifacts/${appId}/public/data/${userId}_${collectionName}`;
}

async function syncDataFromFirestore() {
    if (!window.db || !window.isAuthReady) {
        // Fallback na LocalStorage
        arealData = JSON.parse(localStorage.getItem('jvs_areal_data')) || initialAreas;
        showToast("Naƒçteno z lok√°ln√≠ho √∫lo≈æi≈°tƒõ (offline)", 'warning');
        window.applyFilters();
        return;
    }

    const colRef = window.collection(window.db, getFirestorePath('areals'));
    
    // Nastav√≠me listener pro real-time aktualizace
    window.onSnapshot(colRef, (snapshot) => {
        const firestoreAreas = snapshot.docs.map(doc => ({
            ...doc.data(),
            docId: doc.id,
            // P≈ôevedeme Firestore Timestamp na Date string
            last_maintenance: doc.data().last_maintenance ? doc.data().last_maintenance.toDate().toISOString().substring(0, 10) : '2025-01-01',
            is_maintained: doc.data().is_maintained || false
        }));

        if (firestoreAreas.length === 0) {
            // Prvn√≠ spu≈°tƒõn√≠ - nahrajeme initialAreas do Firestore
            uploadInitialData(colRef);
            return;
        }

        arealData = firestoreAreas;
        localStorage.setItem('jvs_areal_data', JSON.stringify(arealData));
        showToast(`Naƒçteno ${arealData.length} are√°l≈Ø z Firestore.`, 'success');
        window.applyFilters(); // P≈ôenastav√≠ markery a statistiky
    }, (error) => {
        console.error("Chyba p≈ôi naƒç√≠t√°n√≠ dat z Firestore:", error);
        showToast("Chyba synchronizace s Firestore. Pou≈æ√≠v√°m lok√°ln√≠ data.", 'danger');
        arealData = JSON.parse(localStorage.getItem('jvs_areal_data')) || initialAreas;
        window.applyFilters();
    });
}

function uploadInitialData(colRef) {
    initialAreas.forEach(async (area) => {
        // Simulace, ≈æe 10 are√°l≈Ø je hotov√Ωch z minul√© √∫dr≈æby
        area.is_maintained = Math.random() < 0.25;
        try {
            await window.addDoc(colRef, {
                ...area,
                lat: parseFloat(area.lat),
                lng: parseFloat(area.lng),
                area: parseFloat(area.area),
                fence: parseFloat(area.fence),
                // P≈ôevedeme last_maintenance na serverTimestamp nebo Date
                last_maintenance: new Date(area.last_maintenance) 
            });
        } catch (e) {
            console.error("Chyba p≈ôi nahr√°v√°n√≠ prvotn√≠ch dat:", e);
        }
    });
    showToast("Prvotn√≠ data nahr√°na do Firestore. Poƒçkejte na naƒçten√≠.", 'warning');
}

async function saveAreaToFirestore(area, isNew) {
    if (!window.db || !area.docId) {
        showToast("Data ulo≈æena pouze lok√°lnƒõ (Offline/Host).", 'warning');
        localStorage.setItem('jvs_areal_data', JSON.stringify(arealData));
        window.applyFilters();
        return;
    }

    const areaRef = window.doc(window.db, getFirestorePath('areals'), area.docId);

    try {
        const updateData = {
            name: area.name,
            district: area.district,
            cat: area.cat,
            area: parseFloat(area.area),
            fence: parseFloat(area.fence),
            lat: parseFloat(area.lat),
            lng: parseFloat(area.lng),
            is_maintained: area.is_maintained || false,
            // last_maintenance se aktualizuje pouze p≈ôi "Hotovo"
        };

        await window.setDoc(areaRef, updateData, { merge: true });
        showToast(`Are√°l '${area.name}' √∫spƒõ≈°nƒõ ulo≈æen.`, 'success');
    } catch (e) {
        console.error("Chyba p≈ôi ukl√°d√°n√≠ are√°lu do Firestore:", e);
        showToast("Chyba: Zmƒõny nebyly synchronizov√°ny s Firestore.", 'danger');
    }
}

async function toggleMaintenanceStatus(docId) {
    if (!window.db || !docId) {
        showToast("Offline: Status nen√≠ synchronizov√°n.", 'warning');
        return;
    }
    
    const area = arealData.find(a => a.docId === docId);
    if (!area) return;

    const areaRef = window.doc(window.db, getFirestorePath('areals'), docId);
    const newStatus = !area.is_maintained;
    
    try {
        await window.updateDoc(areaRef, {
            is_maintained: newStatus,
            // Nastav√≠me serverTimestamp jen pokud se dokonƒçuje √∫dr≈æba
            last_maintenance: newStatus ? window.serverTimestamp() : area.last_maintenance 
        });
        showToast(`Stav √∫dr≈æby pro '${area.name}' aktualizov√°n na: ${newStatus ? 'Hotovo ‚úÖ' : 'K √∫dr≈æbƒõ üõ†Ô∏è'}`, 'success');
    } catch (e) {
        console.error("Chyba p≈ôi zmƒõnƒõ statusu √∫dr≈æby:", e);
        showToast("Chyba: Nelze aktualizovat status √∫dr≈æby.", 'danger');
    }
}

// === MAPA A MARKERY ===

window.initMap = () => {
    map = L.map('map', {zoomControl: false}).setView([49.2, 14.5], 9);
    
    L.control.zoom({position: 'topright'}).addTo(map);

    // P≈ôep√≠n√°n√≠ vrstev
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OSM' });
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles ¬© Esri' });
    
    osm.addTo(map);
    map.addLayer(clusterGroup);
    map.addLayer(drawingLayer);
    
    const baseLayers = {"Z√°kladn√≠ (OSM)": osm, "Satelitn√≠ (Esri)": satellite};
    const overlayLayers = {"Rizikov√° Heatmapa": heatLayer, "Are√°ly": clusterGroup};
    L.control.layers(baseLayers, overlayLayers, { position: 'bottomright' }).addTo(map);
    
    // Draw Control pro mƒõ≈ôen√≠ a p≈ôid√°n√≠ are√°lu
    drawControl = new L.Control.Draw({
        position: 'topleft',
        edit: { featureGroup: drawingLayer },
        draw: {
            polygon: { shapeOptions: { color: '#3b82f6' }, title: 'Mƒõ≈ôen√≠ plochy' },
            polyline: { shapeOptions: { color: '#f59e0b' }, title: 'Mƒõ≈ôen√≠ vzd√°lenosti' },
            rectangle: false, circle: false, circlemarker: false,
            marker: { title: 'P≈ôidat are√°l', icon: L.icon({ iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2NmMTQyYSIgZD0iTTEyIDBDNi41IDAgMiA0LjUgMiAxMGMwIDcgNSA5IDAgMTEuNUwxMiAyNGwxMC01LjVDMjIgMjEuNSAxNy41IDE3IDIyIDEwQzIyIDQuNSAxNy41IDAgMTIgMFoiLz48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI0IiBmaWxsPSIjRkZGIi8+PC9zdmc+Cg==', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }) }
        }
    });

    map.on(L.Draw.Event.Created, function (e) {
        const type = e.layerType;
        const layer = e.layer;
        drawingLayer.addLayer(layer);

        if (type === 'marker' && isDrawing) {
            addNewAreaForm(layer.getLatLng());
            isDrawing = false;
        }

        if (type === 'polygon') {
            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            showToast(`Vypoƒçten√° plocha: ${(area / 10000).toFixed(2)} ha (${area.toFixed(0)} m¬≤)`, 'primary');
        }
        
        if (type === 'polyline') {
            const distance = L.GeometryUtil.length(layer.getLatLngs());
            showToast(`Vypoƒçten√° vzd√°lenost: ${(distance / 1000).toFixed(2)} km (${distance.toFixed(0)} m)`, 'primary');
        }
    });

    map.on(L.Draw.Event.DrawStart, function(e) {
         if (e.layerType === 'marker') { isDrawing = true; }
    });

    map.on('moveend', window.updateWeather);
    
    // Zaji≈°tƒõn√≠ spr√°vn√© velikosti po initu
    setTimeout(() => map.invalidateSize(), 100);
}

window.renderMarkers = async () => {
  clusterGroup.clearLayers();
  
  // Zobrazit pouze are√°ly, kter√© nejsou dokonƒçeny, pokud je toggle zapnut√Ω
  const onlyRemaining = document.getElementById('maintainedToggle').checked;
  const dataToRender = filteredAreas.filter(a => !onlyRemaining || !a.is_maintained);

  // Spoƒç√≠t√°me Heatmap data a celkov√© statistiky
  heatLayer.setLatLngs([]);
  let remainingArea = 0;
  let totalArea = 0;
  let totalFence = 0;

  dataToRender.forEach(a => {
      const riskScore = calculateRiskScore(a);
      
      // Pro Heatmapu - s√≠la bodu je riskScore * 10 (pro lep≈°√≠ vizualizaci)
      if (riskScore > 0) {
          heatLayer.addLatLng([a.lat, a.lng, riskScore * 10]); 
          remainingArea += a.area;
      }
      
      totalArea += a.area;
      totalFence += a.fence;
      
      // Barevn√© markery
      let markerColor = a.is_maintained ? '#10b981' : '#f59e0b'; // Zelen√° (Hotovo), Oran≈æov√° (K √∫dr≈æbƒõ)
      if (riskScore > 0.6) markerColor = '#ef4444'; // ƒåerven√° (Vysok√© riziko)

      const popup = `
        <div class="popup space-y-2 text-sm">
          <h3 class="font-bold text-lg text-primary">${a.name}</h3>
          <p>Okres: ${a.district} | Kategorie: <span class="badge" style="background:${a.cat==='I.'?'#3b82f6':a.cat==='II.'?'#f59e0b':'#64748b'}">${a.cat || 'Bez'}</span></p>
          <p>Plocha: ${a.area.toLocaleString('cs-CZ')} m¬≤ | Oplocen√≠: ${a.fence} bm</p>
          <p class="text-xs opacity-70">Posledn√≠ √∫dr≈æba: ${a.last_maintenance}</p>
          <div class="flex items-center justify-between pt-2">
            <button class="bg-primary text-white p-2 rounded text-xs hover:bg-primary/90 transition-colors" onclick="addToRoute('${a.docId}')"><i class="fas fa-route"></i> Trasa</button>
            <button class="text-sm px-2 py-1 rounded-full ${a.is_maintained ? 'bg-success/50 text-success' : 'bg-danger/50 text-danger'}" onclick="window.toggleMaintenanceStatus('${a.docId}')">
                <i class="fas ${a.is_maintained ? 'fa-check-circle' : 'fa-tools'}"></i> ${a.is_maintained ? 'Hotovo' : 'K √∫dr≈æbƒõ'}
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-3">
            <button class="bg-blue-600 text-white py-1 rounded text-sm hover:bg-blue-500" onclick="window.editArea('${a.docId}')"><i class="fas fa-edit"></i> Upravit</button>
            <button class="bg-danger text-white py-1 rounded text-sm hover:bg-danger/90" onclick="window.deleteArea('${a.docId}', '${a.name}')"><i class="fas fa-trash"></i> Smazat</button>
            <a href="https://www.google.com/maps/search/?api=1&query=${a.lat},${a.lng}" target="_blank" class="text-center text-blue-400 text-sm col-span-2 mt-1">Otev≈ô√≠t v Google Maps</a>
          </div>
        </div>
      `;

      const marker = L.circleMarker([a.lat, a.lng], {
          radius: 8, 
          color: markerColor, 
          fillOpacity: 0.9,
          weight: 1
      }).bindPopup(popup);
      
      marker.areaData = a; // Ulo≈æen√≠ dat do markeru
      clusterGroup.addLayer(marker);
  });
  
  // Aktualizace statistik
  document.getElementById('totalArea').textContent = arealData.reduce((sum, a) => sum + a.area, 0).toLocaleString('cs-CZ');
  document.getElementById('remainingArea').textContent = arealData.filter(a => !a.is_maintained).reduce((sum, a) => sum + a.area, 0).toLocaleString('cs-CZ');
  document.getElementById('totalFence').textContent = arealData.reduce((sum, a) => sum + a.fence, 0).toLocaleString('cs-CZ');
  document.getElementById('objectCount').textContent = dataToRender.length;
}

window.toggleHeatmap = () => {
    if (document.getElementById('heatmapToggle').checked) {
        map.addLayer(heatLayer);
    } else {
        map.removeLayer(heatLayer);
    }
}

// === ROUTING ===
window.addToRoute = (docId) => {
    const area = arealData.find(a => a.docId === docId);
    if (!area) return;
    
    // Zkontrolujeme, jestli u≈æ tam nen√≠, abychom nezpomalovali
    if (!routePoints.some(p => p.docId === docId)) {
        routePoints.push(area);
        localStorage.setItem('jvs_route_points', JSON.stringify(routePoints));
        showToast(`P≈ôid√°no: ${area.name} do trasy.`, 'primary');
    }
    
    updateRoute();
}

window.updateRoute = () => {
    if (routingControl) map.removeControl(routingControl);
    
    const waypoints = routePoints.map(p => L.latLng(p.lat, p.lng));
    const routeListEl = document.getElementById('routeList');
    const routeStatusEl = document.getElementById('routeStatus');
    routeListEl.innerHTML = '';

    if (waypoints.length < 2) {
        routeStatusEl.textContent = 'Trasa nen√≠ aktivn√≠. P≈ôidejte alespo≈à 2 are√°ly.';
        return;
    }
    
    // Zobrazen√≠ bod≈Ø trasy v panelu (s drag&drop simulac√≠)
    routePoints.forEach((p, index) => {
        const item = document.createElement('div');
        item.className = 'bg-slate-700 p-2 rounded-lg flex items-center justify-between text-sm';
        item.innerHTML = `<span>${index + 1}. ${p.name}</span> 
                          <button onclick="removeFromRoute('${p.docId}')" class="text-danger ml-2"><i class="fas fa-times"></i></button>`;
        routeListEl.appendChild(item);
    });
    
    // Vytvo≈ôen√≠ trasy (OSRM)
    routingControl = L.Routing.control({
        waypoints: waypoints,
        routeWhileDragging: true,
        show: false, // Nechceme, aby se zobrazoval defaultn√≠ panel OSRM
        lineOptions: {styles: [{color: '#3b82f6', weight: 6, opacity: 0.7}]},
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1' // Ve≈ôejn√Ω OSRM
        }),
        // Optimalizace je zapnut√° (autoRoute: true je default)
        autoRoute: true 
    }).on('routesfound', function(e) {
        const route = e.routes[0];
        const distanceKm = (route.summary.totalDistance / 1000).toFixed(1);
        const timeHours = (route.summary.totalTime / 3600).toFixed(1);
        
        routeStatusEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> Trasa nalezena! 
                                   <br>Vzd√°lenost: **${distanceKm} km** <br>ƒåas (j√≠zda): **${timeHours} hodiny**`;
        
        // Aktualizace routePoints pro ulo≈æen√≠ optimalizovan√©ho po≈ôad√≠
        routePoints = route.waypoints.map(wp => {
            const original = routePoints.find(a => a.lat === wp.latLng.lat && a.lng === wp.latLng.lng);
            return original || { lat: wp.latLng.lat, lng: wp.latLng.lng, name: wp.name };
        });
        localStorage.setItem('jvs_route_points', JSON.stringify(routePoints));
        
    }).on('routingerror', function() {
        routeStatusEl.textContent = 'Chyba p≈ôi v√Ωpoƒçtu trasy. Zkuste to znovu.';
    }).addTo(map);
}

window.removeFromRoute = (docId) => {
    routePoints = routePoints.filter(p => p.docId !== docId);
    localStorage.setItem('jvs_route_points', JSON.stringify(routePoints));
    showToast('Are√°l odstranƒõn z trasy.', 'warning');
    updateRoute();
}

window.resetRoute = () => {
    routePoints = [];
    localStorage.removeItem('jvs_route_points');
    if (routingControl) map.removeControl(routingControl);
    document.getElementById('routeStatus').textContent = 'Trasa nen√≠ aktivn√≠. P≈ôidejte alespo≈à 2 are√°ly.';
    showToast('Trasa byla resetov√°na.', 'warning');
    updateRoute();
}


// === EDIT/DELETE/ADD (Modaly) ===
window.addNewAreaInit = () => {
    // P≈ôid√°me drawControl, pokud je≈°tƒõ nen√≠, a aktivujeme re≈æim markeru
    if (!map.hasControl(drawControl)) {
        map.addControl(drawControl);
    }
    drawControl.setDrawingOptions({
        marker: {
            title: 'Nov√Ω are√°l',
            repeatMode: false
        }
    });

    // Simulace kliknut√≠ na tlaƒç√≠tko markeru v Draw Control
    const markerButton = document.querySelector('.leaflet-draw-draw-marker');
    if (markerButton) {
        markerButton.click();
        showToast("Kliknƒõte na mapu pro um√≠stƒõn√≠ nov√©ho are√°lu.", 'primary');
    }
}

window.addNewAreaForm = (latLng) => {
    // Skryjeme Draw Control po um√≠stƒõn√≠
    if (map.hasControl(drawControl)) map.removeControl(drawControl);
    
    document.getElementById('modalTitle').textContent = 'P≈ôidat nov√Ω are√°l';
    
    // Vypr√°zdnƒõn√≠ formul√°≈ôe
    document.getElementById('areaForm').reset();
    document.getElementById('areaIndex').value = ''; 
    document.getElementById('areaLat').value = latLng.lat;
    document.getElementById('areaLng').value = latLng.lng;

    document.getElementById('modal').classList.remove('hidden');
}

window.editArea = (docId) => {
    const area = arealData.find(a => a.docId === docId);
    if (!area) return;

    document.getElementById('modalTitle').textContent = `Upravit: ${area.name}`;
    
    document.getElementById('areaIndex').value = docId;
    document.getElementById('areaName').value = area.name;
    document.getElementById('areaDistrict').value = area.district;
    document.getElementById('areaCategory').value = area.cat || '';
    document.getElementById('areaArea').value = area.area;
    document.getElementById('areaFence').value = area.fence;
    document.getElementById('areaLat').value = area.lat;
    document.getElementById('areaLng').value = area.lng; // Lze p≈ôidat i drag pro zmƒõnu polohy
    
    document.getElementById('modal').classList.remove('hidden');
}

window.deleteArea = (docId, name) => {
    // Pou≈æijeme modal/custom dialog nam√≠sto confirm()
    const doDelete = confirm(`Opravdu chcete smazat are√°l '${name}'? Tato akce je nevratn√°.`);
    
    if (doDelete) {
        const index = arealData.findIndex(a => a.docId === docId);
        if (index > -1) {
            arealData.splice(index, 1);
            window.deleteAreaFromFirestore(docId, name);
        }
    }
}

window.deleteAreaFromFirestore = async (docId, name) => {
    if (!window.db || !docId) {
        showToast("Smaz√°no pouze lok√°lnƒõ. Offline m√≥d.", 'warning');
        localStorage.setItem('jvs_areal_data', JSON.stringify(arealData));
        window.applyFilters();
        return;
    }
    
    const areaRef = window.doc(window.db, getFirestorePath('areals'), docId);
    try {
        await window.deleteDoc(areaRef);
        showToast(`Are√°l '${name}' smaz√°n.`, 'danger');
    } catch (e) {
        console.error("Chyba p≈ôi maz√°n√≠ are√°lu:", e);
        showToast("Chyba: Are√°l nebyl smaz√°n z Firestore.", 'danger');
    }
}

window.hideModal = () => {
    document.getElementById('modal').classList.add('hidden');
}

document.getElementById('areaForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    window.hideModal();
    
    const docId = document.getElementById('areaIndex').value;
    const name = document.getElementById('areaName').value;
    const district = document.getElementById('areaDistrict').value;
    const cat = document.getElementById('areaCategory').value.toUpperCase();
    const area = parseFloat(document.getElementById('areaArea').value);
    const fence = parseFloat(document.getElementById('areaFence').value);
    const lat = parseFloat(document.getElementById('areaLat').value);
    const lng = parseFloat(document.getElementById('areaLng').value);

    const isNew = !docId;
    let newArea = { name, district, cat, area, fence, lat, lng, is_maintained: false, last_maintenance: new Date().toISOString().substring(0, 10) };

    if (isNew) {
        // Nov√Ω are√°l - p≈ôid√°me do Firestore/lok√°lnƒõ
        if (window.db) {
            const colRef = window.collection(window.db, getFirestorePath('areals'));
            const docRef = await window.addDoc(colRef, { ...newArea, last_maintenance: new Date(newArea.last_maintenance) });
            newArea.docId = docRef.id;
        } else {
            newArea.docId = crypto.randomUUID(); // Generujeme ID lok√°lnƒõ
            arealData.push(newArea);
        }
    } else {
        // Editace existuj√≠c√≠ho are√°lu
        const index = arealData.findIndex(a => a.docId === docId);
        if (index > -1) {
            const existingArea = arealData[index];
            existingArea.name = name;
            existingArea.district = district;
            existingArea.cat = cat;
            existingArea.area = area;
            existingArea.fence = fence;
            existingArea.lat = lat;
            existingArea.lng = lng;
            newArea = existingArea;
        }
    }

    await saveAreaToFirestore(newArea, isNew);
});


// === FILTRY A STATISTIKY ===
window.applyFilters = () => {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const district = document.getElementById('districtFilter').value;
  const onlyRemaining = document.getElementById('maintainedToggle').checked;

  filteredAreas = arealData.filter(a => 
    a.name.toLowerCase().includes(search) &&
    (!district || a.district === district)
  );

  window.renderMarkers();
}

window.resetFilters = () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('districtFilter').value = '';
    document.getElementById('maintainedToggle').checked = false;
    window.applyFilters();
}

window.resetAllData = () => {
    const doReset = confirm("Tato akce vyma≈æe ve≈°ker√° data (are√°ly, trasu) lok√°lnƒõ! D√°le se pokus√≠ smazat i data z Firestore. OPRAVDU CHCETE POKRAƒåOVAT?");
    if (doReset) {
        localStorage.clear();
        showToast("Lok√°ln√≠ data vymaz√°na. Pro glob√°ln√≠ reset restartujte aplikaci.", 'danger');
        // V re√°ln√© aplikaci by zde n√°sledovalo maz√°n√≠ dat z Firestore pod u≈æivatelem/appId.
        window.location.reload(); 
    }
}


// === WEATHER & AI ===

window.updateWeather = async () => {
  const center = map.getCenter();
  const weatherContent = document.getElementById('weatherContent');
  weatherContent.innerHTML = `<div class="spinner"></div>`;
  
  try {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${center.lat}&longitude=${center.lng}&current=temperature_2m,precipitation,wind_speed_10m,cloud_cover,is_day&hourly=pm10,pm2_5&forecast_days=1`);
    const d = await r.json();
    const c = d.current;
    const h = d.hourly;
    
    // Najdeme nejbli≈æ≈°√≠ hodinovou hodnotu kvality ovzdu≈°√≠
    const nowHourIndex = new Date().getHours();
    const pm10 = h.pm10[nowHourIndex];
    const pm25 = h.pm2_5[nowHourIndex];
    
    weatherContent.innerHTML = `
      <div class="text-3xl font-bold mb-1">${c.temperature_2m} ¬∞C</div>
      <div class="flex justify-center gap-4 text-sm">
        <span class="opacity-80"><i class="fas fa-umbrella"></i> ${c.precipitation} mm</span>
        <span class="opacity-80"><i class="fas fa-wind"></i> ${c.wind_speed_10m} km/h</span>
        <span class="opacity-80"><i class="fas fa-cloud"></i> ${c.cloud_cover}%</span>
      </div>
      <div class="mt-2 text-xs">
        Kvalita vzduchu (PM): <span class="font-semibold">${pm10} ¬µg/m¬≥ PM10 / ${pm25} ¬µg/m¬≥ PM2.5</span>
      </div>
    `;
  } catch(e) {
    console.error("Chyba p≈ôi naƒç√≠t√°n√≠ poƒças√≠:", e);
    weatherContent.textContent = 'Poƒças√≠ nedostupn√©';
  }
}

window.generateAIReport = async () => {
    if (routePoints.length < 2) {
        showToast("Trasa mus√≠ obsahovat minim√°lnƒõ 2 are√°ly pro generov√°n√≠ AI protokolu.", 'warning');
        return;
    }

    const reportBtn = document.querySelector('#panelContent button.bg-purple-600');
    const originalText = reportBtn.innerHTML;
    reportBtn.innerHTML = `<i class="fas fa-sync fa-spin"></i> Generuji...`;
    reportBtn.disabled = true;

    const routeNames = routePoints.map(p => p.name).join(', ');
    
    // Z√≠sk√°me detail trasy, pokud routingControl existuje a m√° spoƒç√≠tanou trasu
    let routeInfo = "Trasa nen√≠ k dispozici pro detailn√≠ souhrn (offline).";
    if (routingControl && routingControl.getPlan().getWaypoints().length > 0) {
         try {
            const routes = routingControl.getRoutableTile().getRoutes();
            if (routes.length > 0 && routes[0].summary) {
                const summary = routes[0].summary;
                const distanceKm = (summary.totalDistance / 1000).toFixed(1);
                const timeMinutes = Math.ceil(summary.totalTime / 60);
                routeInfo = `Celkov√° d√©lka j√≠zdy: ${distanceKm} km, odhadovan√Ω ƒças j√≠zdy: ${timeMinutes} minut. Are√°ly v po≈ôad√≠: ${routeNames}.`;
            }
         } catch (e) {
             // OSRM nemus√≠ b√Ωt v≈ædy dostupn√©, pou≈æijeme fallback
         }
    }

    const systemPrompt = "Jsi provozn√≠ dispeƒçer JVS. Tv√Ωm √∫kolem je vytvo≈ôit kr√°tk√Ω, ale profesion√°ln√≠ protokol √∫dr≈æby pro technika na z√°kladƒõ zadan√© trasy. Protokol by mƒõl m√≠t nadpis, shrnut√≠, ƒçasov√Ω odhad a akƒçn√≠ seznam.";
    const userQuery = `Vytvo≈ô protokol √∫dr≈æby pro technika, kter√Ω m√° nav≈°t√≠vit are√°ly: ${routeNames}. P≈ôid√°v√°m informaci o trase: ${routeInfo}. Vytvo≈ô checklist s 5 hlavn√≠mi √∫koly √∫dr≈æby pro are√°ly (nap≈ô. sek√°n√≠ tr√°vy, kontrola ƒçerpadel).`;
    const apiKey = ""; // Canvas runtime poskytne kl√≠ƒç
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        tools: [{ "google_search": {} }], // Pro p≈ô√≠pad, ≈æe bude pot≈ôeba info o are√°lu
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Chyba generov√°n√≠ protokolu.";
        
        // Zobraz√≠me protokol v nov√©m modalu (zde jako alert pro jednoduchost, ale s form√°tov√°n√≠m)
        alert("--- Protokol √ödr≈æby (AI) ---\n\n" + generatedText);

    } catch (error) {
        console.error("Chyba vol√°n√≠ Gemini API:", error);
        showToast("Chyba p≈ôi komunikaci s AI pro generov√°n√≠ protokolu.", 'danger');
    } finally {
        reportBtn.innerHTML = originalText;
        reportBtn.disabled = false;
    }
}


// === PANEL TOGGLE & INIT ===
window.togglePanel = () => {
    const panel = document.getElementById('panel');
    const icon = document.getElementById('panelHandleIcon');
    const isOpen = panel.style.transform === 'translateY(0px)'; // Kontrola, zda je transformace 0
    
    if (isOpen) {
        panel.style.transform = 'translateY(calc(100% - 70px))';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        panel.style.transform = 'translateY(0px)';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
    
    // D≈Øle≈æit√©: Invalidate size po zmƒõnƒõ velikosti pro Leaflet
    setTimeout(() => map.invalidateSize(), 350);
}

// === REGISTRACE EVENT LISTENERS ===
document.getElementById('searchInput').addEventListener('input', window.applyFilters);
document.getElementById('districtFilter').addEventListener('change', window.applyFilters);
document.getElementById('maintainedToggle').addEventListener('change', window.applyFilters);
document.getElementById('locateBtn').onclick = () => {
  navigator.geolocation.getCurrentPosition(p => {
    map.setView([p.coords.latitude, p.coords.longitude], 15);
    showToast('Va≈°e poloha nalezena.', 'primary');
  }, () => showToast('Geolokace selhala: Zkontrolujte opr√°vnƒõn√≠.', 'danger'));
};


// === GLOB√ÅLN√ç INICIALIZACE PO AUTHENTIKACI ===
window.initApp = () => {
    // 1. Inicializace mapy (pokud je≈°tƒõ nebyla)
    if (!map) {
        window.initMap();
        map.fitBounds(initialAreas.map(a => [a.lat, a.lng]));
        map.setMinZoom(8);
        map.setMaxZoom(19);
    }
    
    // 2. Naplnƒõn√≠ filtru okres≈Ø
    const districts = [...new Set(initialAreas.map(a => a.district))].sort();
    const districtSelect = document.getElementById('districtFilter');
    if (districtSelect.options.length === 1) { // Prevence duplik√°t≈Ø
        districts.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            districtSelect.appendChild(opt);
        });
    }

    // 3. Synchronizace dat (triggeruje renderMarkers)
    window.syncDataFromFirestore();
    
    // 4. Nastaven√≠ trasy (pokud je ulo≈æen√°)
    window.updateRoute();

    // 5. Oprava velikosti a otev≈ôen√≠ panelu
    setTimeout(() => {
        map.invalidateSize();
        // Otev≈ô√≠t panel na mobilu p≈ôi startu (v√Ωchoz√≠ je zav≈ôen√Ω)
        if (window.innerWidth < 768) {
            togglePanel();
        }
    }, 500);
    
    // PWA Service Worker (sw.js separ√°tnƒõ)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(() => console.log('Service Worker registrov√°n'))
            .catch(error => console.warn('Service Worker selhal:', error));
    }
    
    // Periodick√© aktualizace poƒças√≠
    setInterval(window.updateWeather, 600000); // 10 min
};

// Zaji≈°tƒõn√≠, ≈æe se initApp spust√≠ jen jednou po dokonƒçen√≠ Firebase Autentizace
if (window.isAuthReady) {
    window.initApp();
}

// iOS fixy a resize
window.addEventListener('orientationchange', () => setTimeout(() => map.invalidateSize(), 500));
window.addEventListener('resize', () => setTimeout(() => map.invalidateSize(), 500));
</script>

</body>
</html>

